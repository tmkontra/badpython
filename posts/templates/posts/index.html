{% extends "posts/_layout.html" %}
{% block content %}
<div class="row d-flex justify-content-center">
    <h3>{{ post.title }}</h3>
</div>
<div id="code-container" class="container" style="max-width: 80%; position: relative; padding: 0px;">
    <button class='btn btn-outline-dark' id="suggestion" style="color: darkgray; border-color: dar;">
        <i class="far fa-lightbulb"></i>
        suggest...
    </button>
    <pre style="margin-bottom: 0.1rem;">
        <code id="code" class="python px-5" style="line-height: 1.5rem; min-height: 10%; max-height: 50%; overflow-y: scroll;">
{{ post.code }}
        </code>
    </pre>
    <div class="row" style="margin: auto;" class="mx-auto">
        <button id="bad-btn" class="btn btn-success">
            <i class="far fa-thumbs-up"></i>
            This <em>is</em> bad python!
        </button>
        <button id="not-bad-btn" class="btn btn-danger ml-auto">
            <i class="far fa-ban"></i>
            This isn't that bad!
        </button>
    </div>
</div>

<div id="modal-body-success" style="display: none;">
    <button class="btn btn-outline-dark">
        <i class="far fa-lightbulb"></i>
        Share How You'd Fix It
    </button>
    <a href="{% url 'index' %}?p={{post.id}}" class="btn btn-primary">
        <i class="fa fa-forward"></i>
        See Another
    </a>
</div>

<div id="modal-body-failed" style="display: none;">
    <a href="{% url 'index' %}?p={{post.id}}" class="btn btn-primary">
        <i class="fa fa-forward"></i>
        See Another
    </a>
</div>

<div class="modal" role="dialog" id="after-vote-modal">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="vote-modal-title">Thanks for voting!</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body d-flex justify-content-around" id="vote-modal-body">
        
            </div>
        </div>
    </div>
</div>

<script>
    set_suggest_button_position = function () {
        let c = $("#code");
        let x = c.position();
        let s = $("#suggestion");
        s.css({ top: x.top, right: x.left, position: 'absolute' });
    };
    $(window).on('resize', set_suggest_button_position);
    $(document).ready(function() { set_suggest_button_position(); set_suggest_button_position()});
    $("#code-container").bind("reposition", set_suggest_button_position);

    var post_url = '{% url "vote" post.id %}'

    let modal = $("#after-vote-modal");
    let modalTitle = $("#vote-modal-title");

    let body = $("#vote-modal-body");

    let vote_success = function () {
        let s = $("#modal-body-success");
        let h = s.html();
        body.html(h);
        modal.modal("show");
    };

    let vote_failed = function () {
        let h = $("#modal-body-failed").html();
        body.html(h);
        modal.modal("show");
    };

    let vote_respose_handler = function (response) {
        if (response.status == 200) {
            vote_success()
        } else if (response.status == 202) {
            vote_success()
        } else {
            vote_failed()
        }
    };
    
    let vote_for_post = function (is_bad) {
        let handler;
        if (is_bad) {
            handler = vote_success;
        } else {
            handler = vote_failed;
        };
        console.log(`currying ${is_bad}`);
        let vote = function (ev) {
            fetch(post_url, {
                method: "POST",
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken,
                },
                body: JSON.stringify({
                    isBad: is_bad,
                })
            }).then(handler)
        };
        return vote;
    };

    $("#bad-btn").click(vote_for_post(true));
    $("#not-bad-btn").click(vote_for_post(false));
</script>

{% endblock %}